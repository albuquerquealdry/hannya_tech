{{ define "title" }}{{ .Title }} :: {{ .Site.Title }}{{ end }}
{{ define "main" }}
  {{ $cover := or .Params.capa .Params.cover }}
  {{ $total := len .Params.checkpoints }}
  {{ $done := len (where .Params.checkpoints "done" true) }}
  {{ $percent := 0 }}
  {{ if gt $total 0 }}
    {{ $percent = div (mul $done 100) $total }}
  {{ end }}

  <div class="hannya-container" style="max-width: 1400px;">
    {{ with $cover }}
    {{ $src := cond (hasPrefix . "/") (relURL (substr . 1)) (relURL .) }}
    <div class="hero-cover" style="width: 100%; height: clamp(220px, 35vw, 380px); border-radius: 16px; overflow: hidden; margin: 0 auto 1.5rem; box-shadow: 0 8px 28px rgba(0,0,0,.25);">
      <img src="{{ $src }}" alt="capa" style="width: 100%; height: 100%; object-fit: cover; display: block;">
    </div>
    {{ end }}
    <header style="margin-bottom: 2.5rem; max-width: 1100px; margin-left: auto; margin-right: auto;">
      <h1 class="hannya-title" style="margin-bottom: 1rem; font-size: clamp(2rem, 4vw, 2.75rem);">{{ .Title }}</h1>
      <p class="hannya-subtitle" style="font-size: clamp(1rem, 2vw, 1.2rem); line-height: 1.7; margin-bottom: 1.25rem; max-width: 900px;">{{ or .Params.summary .Summary }}</p>
      <div class="chips" style="align-items: center; gap: 0.5rem;">
        {{ range .Params.tags }}<span class="chip">{{ . }}</span>{{ end }}
        {{ $status := default "em progresso" .Params.status }}
        <a class="badge {{ if eq $status "conclu√≠do" }}success{{ else if eq $status "rascunho" }}warn{{ end }}" href="{{ (printf "/status/%s" (urlize $status)) | relLangURL }}" style="text-decoration: none;">{{ $status }}</a>
      </div>
    </header>

    <!-- Resumo compacto com progresso destacado no topo -->
    <section class="summary box" style="background: linear-gradient(135deg, rgba(124, 58, 237, 0.08), rgba(167, 139, 250, 0.08)); max-width: 1100px; margin: 0 auto 2rem; border: 2px solid var(--accent-2); box-shadow: 0 4px 20px rgba(124, 58, 237, 0.1);">
      <div class="summary-row" style="gap: 1.5rem;">
        <div class="summary-title" style="font-size: 1.1rem; font-weight: 700;">{{ T "pesquisa.progresso" }}</div>
        <div class="summary-progress" style="flex: 1 1 300px;">
          <div class="progress" style="height: 12px; border-radius: 999px;"><div class="progress__bar" style="width: {{ $percent }}%;"></div></div>
        </div>
        <div class="summary-kpis" style="font-weight: 700; gap: 1rem;">
          <span style="font-size: 1rem;">{{ $done }}/{{ $total }} checkpoints</span>
          <span style="color: var(--accent); font-size: 1.3rem;">{{ $percent }}%</span>
        </div>
      </div>
    </section>

    <!-- Layout em duas colunas: Vis√£o Geral √† esquerda; Subpesquisas + Progresso √† direita -->
    <section class="layout-2col" style="gap: 2rem; max-width: 1400px; margin: 0 auto;">
      <article class="content box" style="padding: 2rem;">
        {{ .Content }}
      </article>

      <div class="stack-column">
        <section class="box">
          <h2 style="font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.25rem;">üîç</span>
            {{ T "pesquisa.subpesquisas" }}
          </h2>
          {{ $parentPath := trim .File.Dir "/" }}
          {{ $subs := where .Site.RegularPages "Params.parent_path" "eq" $parentPath }}
          <div class="sub-grid">
            {{ range $subs }}
              {{ if or (eq .File.BaseFileName "sensitive-keys-in-codebases") (eq .File.BaseFileName "dind-docker-in-docker-exploitation") }}
                <a id="subpesquisa-{{ .File.BaseFileName }}" class="card" style="padding: 1rem; text-decoration: none;" href="{{ .RelPermalink }}">
                  <div class="card-header"><h3 style="font-size: 1.1rem;">{{ .Title }}</h3></div>
                  {{ with .Params.summary }}<p class="muted" style="font-size: 0.9rem; line-height: 1.5;">{{ . }}</p>{{ end }}
                </a>
              {{ else }}
                <div id="subpesquisa-{{ .File.BaseFileName }}" class="card" style="padding: 1rem; text-decoration: none; opacity: 0.6; cursor: not-allowed;">
                  <div class="card-header"><h3 style="font-size: 1.1rem;">{{ .Title }}</h3></div>
                  {{ with .Params.summary }}<p class="muted" style="font-size: 0.9rem; line-height: 1.5;">{{ . }}</p>{{ end }}
                  <p class="muted" style="margin-top: 0.5rem; font-size: 0.85rem;">Indispon√≠vel</p>
                </div>
              {{ end }}
            {{ end }}
            {{ if .Params.subpesquisas }}
              {{ range .Params.subpesquisas }}
                {{ $item := . }}
                {{ $slug := cond (isset $item "slug") (urlize $item.slug) (urlize $item.title) }}
                {{ $existing := $.Site.GetPage "page" (printf "subpesquisa/%s" $slug) }}
                {{ if or (eq $slug "sensitive-keys-in-codebases") (eq $slug "dind-docker-in-docker-exploitation") }}
                  {{ if $existing }}
                    <a id="subpesquisa-{{ $slug }}" class="card" style="padding: 1rem; text-decoration: none;" href="{{ $existing.RelPermalink }}">
                      <div class="card-header"><h3 style="font-size: 1.1rem;">{{ $item.title }}</h3></div>
                      {{ with (or $item.summary $existing.Params.summary) }}<p class="muted" style="font-size: 0.9rem; line-height: 1.5;">{{ . }}</p>{{ end }}
                    </a>
                  {{ else }}
                    <div id="subpesquisa-{{ $slug }}" class="card" style="padding: 1rem; text-decoration: none; opacity: 0.6; cursor: not-allowed;">
                      <div class="card-header"><h3 style="font-size: 1.1rem;">{{ $item.title }}</h3></div>
                      {{ with $item.summary }}<p class="muted" style="font-size: 0.9rem; line-height: 1.5;">{{ . }}</p>{{ end }}
                      <p class="muted" style="margin-top: 0.5rem; font-size: 0.85rem;">Indispon√≠vel</p>
                    </div>
                  {{ end }}
                {{ else }}
                  <div id="subpesquisa-{{ $slug }}" class="card" style="padding: 1rem; text-decoration: none; opacity: 0.6; cursor: not-allowed;">
                    <div class="card-header"><h3 style="font-size: 1.1rem;">{{ $item.title }}</h3></div>
                    {{ with $item.summary }}<p class="muted" style="font-size: 0.9rem; line-height: 1.5;">{{ . }}</p>{{ end }}
                    <p class="muted" style="margin-top: 0.5rem; font-size: 0.85rem;">Indispon√≠vel</p>
                  </div>
                {{ end }}
              {{ end }}
            {{ end }}
            {{ if and (eq (len $subs) 0) (not .Params.subpesquisas) }}
              <p class="muted">{{ T "pesquisa.sem_sub" }}</p>
            {{ end }}
          </div>
        </section>

        <section class="box">
          <h2 style="font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.25rem;">üìã</span>
            {{ T "pesquisa.progresso" }}
          </h2>
      <div class="timeline" style="margin-top: 0.5rem;">
        {{ range .Params.checkpoints }}
          <div id="checkpoint-{{ urlize .title }}" class="checkpoint {{ if .done }}done{{ end }}">
            <div class="dot"></div>
            <div>
              <div class="title">{{ .title }}</div>
              {{ with .notes }}<div class="notes">{{ . }}</div>{{ end }}
            </div>
          </div>
        {{ end }}
      </div>
      </section>

        {{ with .Params.tecnologias }}
        <section class="box">
          <h2 style="font-size: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 1.25rem;">üõ†Ô∏è</span>
            {{ T "pesquisa.tecnologias" }}
          </h2>
          <div class="tech-logos">
            {{ range . }}
              <div class="tech-logo-item">
                {{ if .logo }}
                  <img src="{{ .logo }}" alt="{{ .name }}" title="{{ .name }}">
                  <span class="tech-name">{{ .name }}</span>
                {{ else }}
                  <span class="chip">{{ .name }}</span>
                {{ end }}
              </div>
            {{ end }}
          </div>
        </section>
        {{ end }}
      </div>
    </section>
  </div>
{{ end }}
